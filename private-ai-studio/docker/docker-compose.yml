# Private AI Studio - Complete Docker Compose
# ============================================
# Usage: cp .env.example .env && docker compose up -d

version: '3.8'

services:
  # ==================== REVERSE PROXY ====================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
    networks:
      - ai-network

  # ==================== VECTOR DATABASE ====================
  qdrant:
    image: qdrant/qdrant:v1.7.0
    container_name: qdrant
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qdrant.rule=Host(`qdrant.${DOMAIN}`)"
    networks:
      - ai-network

  # ==================== MODEL SERVING ====================
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    volumes:
      - ollama_models:/root/.ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_NUM_PARALLEL=2
      - OLLAMA_KEEP_ALIVE=24h
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.${DOMAIN}`)"
    networks:
      - ai-network

  # ==================== RESEARCH STUDIO ====================
  openwebui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: openwebui
    depends_on:
      - ollama
    volumes:
      - openwebui_data:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.openwebui.rule=Host(`ai.${DOMAIN}`)"
      - "traefik.http.routers.openwebui.tls.certresolver=letsencrypt"
    networks:
      - ai-network

  # ==================== CREATION STUDIO ====================
  comfyui:
    image: comfyanonymous/comfyui:latest
    container_name: comfyui
    volumes:
      - comfyui_output:/home/user/comfyui/output
      - comfyui_workflows:/home/user/comfyui/userworkflows
      - ./comfyui/custom_nodes:/home/user/comfyui/custom_nodes
    ports:
      - "8188:8188"
    environment:
      - COMFYUI_PORT=8188
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.comfyui.rule=Host(`create.${DOMAIN}`)"
      - "traefik.http.routers.comfyui.tls.certresolver=letsencrypt"
    networks:
      - ai-network

  lobechat:
    image: lobehub/lobe-chat:latest
    container_name: lobechat
    depends_on:
      - comfyui
    volumes:
      - ./lobechat/.env.production.local:/app/.env.production.local
    ports:
      - "3210:3210"
    environment:
      - OPENAI_PROXY_URL=http://comfyui:8000/v1
      - OPENAI_API_KEY=sk-placeholder
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lobechat.rule=Host(`chat.${DOMAIN}`)"
      - "traefik.http.routers.lobechat.tls.certresolver=letsencrypt"
    networks:
      - ai-network

  # ==================== AUTOMATION ====================
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/local_files:/files
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - WEBHOOK_URL=https://automate.${DOMAIN}/
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`automate.${DOMAIN}`)"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
    networks:
      - ai-network

  # ==================== MONITORING ====================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`monitor.${DOMAIN}`)"
    networks:
      - ai-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    depends_on:
      - prometheus
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`monitor.${DOMAIN}`)"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
    networks:
      - ai-network

# ==================== VOLUMES ====================
volumes:
  qdrant_data:
  ollama_models:
  openwebui_data:
  comfyui_output:
  comfyui_workflows:
  n8n_data:
  prometheus_data:
  grafana_data:

# ==================== NETWORKS ====================
networks:
  ai-network:
    driver: bridge
